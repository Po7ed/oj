# Median Replace

给定长度为 $n$ 的 01 序列 $a$，你可以做若干次操作形如把长度为三的子串变成中位数，问可以变成多少个不同的序列。答案对 `998244353` 取模。

$n \le 10^6$

---

### 题解

我们令原串为 $S$，生成的串为 $T$，让我们来考虑对给定的 $S$，是否能生成 $T$。

把 $T$ 分为几个极长的连续相同子串，那么每个 $T$ 的串就对应 $S$ 的一个区间。

如果我们可以选出 $S$ 的若干个不交子串，两个串中间可以空偶数个位置不选，分别把它们交错变成 $0$ 段和 $1$ 段，拼接成 $T$，那么 $S$ 串也可以变成 $T$。

于是我们有这样的 dp：令 $dp_{i,0/1}$ 表示已经使用了 $S$ 的前 $i$ 个位置，上一段是 $0/1$，可以构造多少不同的序列。

转移考虑枚举接下来接长度为多少的串，并选择一个长度最短的前缀接上。

令 $f_{i,j,0}$ 表示为了制造一个长度为 $j$ 的 $0$ 串，需要选取多长的以 $i$ 开头的串。即：
$$
dp_{i,0}\to dp_{f_{i+2k,j,0},1}
$$
（其中 $k$ 为满足 $f_{i+2k,j,0}$ 最小的 $k$，且是偶数。）

暴力的求解每个 $f_{i,j}$，至少可以做到 $O(n^3)$。

让我们来关注如何快速求解这个问题。

如果 $f_{l,a} =x (a \ge 1)$，我们考虑快速计算 $f_{l,a+1}$ 的值。

可以证明 —— 只需找到一个最小的整数 $k$ 满足 $S_{x+2k}=S_{x+2k+1}=0$，我们就有 $f_{l,a+1}=x+2k+1$。

这样就能进行快速的转移了。在此不赘述具体的转移，总复杂度 $O(n)$，可以通过。